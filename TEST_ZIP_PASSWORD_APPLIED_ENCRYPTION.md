# 测试指南：ZIP 密码保护 - applied 目录加密验证

## 测试目标

验证 ZIP 密码保护的补丁在 `applied` 目录保持加密状态，防止用户直接访问和修改。

## 前置条件

1. 已安装 v1.1 APK（基准版本）
2. 已生成 v1.2 APK（新版本）
3. ADB 已连接设备

## 测试场景 1：派生密码（默认）

### 步骤 1：生成补丁

1. 打开应用
2. 选择基准 APK (v1.1) 和新 APK (v1.2)
3. 点击「生成补丁」
4. 勾选「🔑 ZIP 密码保护」
5. **不输入密码**（使用默认派生密码）
6. 点击「生成」
7. 等待生成完成

**预期结果**：
- 补丁生成成功
- 补丁文件大小约 9MB（未压缩）
- 没有 `.zippwd` 标记文件

### 步骤 2：应用补丁

1. 点击「应用补丁」
2. **预期**：不弹出密码输入对话框（使用派生密码）
3. 等待应用完成

**预期结果**：
- 显示「🔥 热更新成功!」
- 不需要输入密码
- 补丁应用成功

### 步骤 3：验证 applied 目录加密

使用 ADB 检查补丁文件：

```bash
# 进入应用私有目录
adb shell
cd /data/data/com.orange.update/files/update/applied

# 查看文件
ls -lh

# 尝试解压（应该失败）
unzip current_patch.zip
```

**预期结果**：
- `current_patch.zip` 文件存在
- 文件大小约 9MB
- **无法直接解压**（提示需要密码）

### 步骤 4：验证自动加载

1. 完全关闭应用（从最近任务中划掉）
2. 重新打开应用

**预期结果**：
- 应用启动成功
- 标题显示「🔥 热更新补丁工具 v1.2」（带火焰）
- 热更新测试信息显示「🔥🔥🔥 热更新测试 v1.2 - 补丁已生效！代码已更新！🔥🔥🔥」
- 补丁自动加载成功（使用派生密码）

---

## 测试场景 2：自定义密码

### 步骤 1：清除旧补丁

1. 打开应用
2. 点击「清除补丁」
3. 重启应用

### 步骤 2：生成补丁（自定义密码）

1. 选择基准 APK (v1.1) 和新 APK (v1.2)
2. 点击「生成补丁」
3. 勾选「🔑 ZIP 密码保护」
4. **输入密码**：`test123`
5. 点击「生成」
6. 等待生成完成

**预期结果**：
- 补丁生成成功
- 生成了 `.zippwd` 标记文件

### 步骤 3：应用补丁（输入密码）

1. 点击「应用补丁」
2. **预期**：弹出密码输入对话框
3. 输入密码：`test123`
4. 点击「验证并应用」
5. 等待应用完成

**预期结果**：
- 弹出密码输入对话框
- 输入密码后验证成功
- 显示「🔥 热更新成功!」
- 补丁应用成功

### 步骤 4：验证 applied 目录加密

使用 ADB 检查补丁文件：

```bash
# 进入应用私有目录
adb shell
cd /data/data/com.orange.update/files/update/applied

# 查看文件
ls -lh

# 尝试解压（应该失败）
unzip current_patch.zip
```

**预期结果**：
- `current_patch.zip` 文件存在
- 文件大小约 9MB
- **无法直接解压**（提示需要密码）

### 步骤 5：验证自动加载（自定义密码）

1. 完全关闭应用（从最近任务中划掉）
2. 重新打开应用

**预期结果**：
- 应用启动成功
- 标题显示「🔥 热更新补丁工具 v1.2」（带火焰）
- 热更新测试信息显示「🔥🔥🔥 热更新测试 v1.2 - 补丁已生效！代码已更新！🔥🔥🔥」
- 补丁自动加载成功（使用保存的自定义密码）

---

## 测试场景 3：密码错误

### 步骤 1：生成补丁（自定义密码）

1. 清除旧补丁
2. 生成新补丁，使用密码：`correct123`

### 步骤 2：应用补丁（输入错误密码）

1. 点击「应用补丁」
2. 弹出密码输入对话框
3. 输入**错误密码**：`wrong123`
4. 点击「验证并应用」

**预期结果**：
- 显示「⚠️ ZIP 密码验证失败！密码错误或补丁已被篡改。」
- 补丁应用失败

### 步骤 3：重新输入正确密码

1. 再次点击「应用补丁」
2. 弹出密码输入对话框
3. 输入**正确密码**：`correct123`
4. 点击「验证并应用」

**预期结果**：
- 密码验证成功
- 显示「🔥 热更新成功!」
- 补丁应用成功

---

## 测试场景 4：防篡改验证

### 步骤 1：生成并应用补丁

1. 生成补丁（使用 ZIP 密码保护）
2. 应用补丁成功

### 步骤 2：篡改 applied 目录的补丁

使用 ADB 修改补丁文件：

```bash
# 进入应用私有目录
adb shell
cd /data/data/com.orange.update/files/update/applied

# 备份原文件
cp current_patch.zip current_patch.zip.bak

# 篡改文件（添加一些随机数据）
echo "tampered" >> current_patch.zip
```

### 步骤 3：重启应用

1. 完全关闭应用
2. 重新打开应用

**预期结果**：
- 应用启动失败或补丁加载失败
- 日志显示「Failed to decrypt ZIP password protected patch」
- 应用回退到基准版本（v1.1）

---

## 验证要点

### ✓ 加密状态验证

- [ ] applied 目录的 `current_patch.zip` 无法直接解压
- [ ] 文件需要密码才能打开
- [ ] 使用错误密码无法解压

### ✓ 密码输入流程

- [ ] 使用派生密码时不弹出密码对话框
- [ ] 使用自定义密码时弹出密码对话框
- [ ] 密码错误时提示验证失败
- [ ] 密码正确时应用成功

### ✓ 自动加载

- [ ] 重启应用后补丁自动加载
- [ ] 使用派生密码的补丁自动解密
- [ ] 使用自定义密码的补丁自动解密（使用保存的密码）

### ✓ 防篡改

- [ ] 篡改后的补丁无法加载
- [ ] 应用回退到基准版本

---

## 常见问题

### Q1: 为什么使用派生密码时不需要输入密码？

**A**: 派生密码是从应用签名自动生成的，每个应用都有唯一的派生密码。这样可以在不需要用户输入的情况下提供基本的加密保护。

### Q2: 自定义密码保存在哪里？

**A**: 自定义密码保存在 SharedPreferences 中（`patch_storage_prefs`），用于应用启动时自动解密补丁。

### Q3: 如果忘记自定义密码怎么办？

**A**: 需要清除补丁并重新应用。可以点击「清除补丁」按钮，然后重新生成和应用补丁。

### Q4: ZIP 密码保护和 AES 加密有什么区别？

**A**: 
- **ZIP 密码保护**：补丁在 applied 目录保持加密状态，防止直接查看和修改
- **AES 加密**：补丁在传输时加密，应用后在 applied 目录解密存储

建议同时使用两者以获得最强的安全保护。

---

## 测试结果记录

| 测试场景 | 预期结果 | 实际结果 | 通过/失败 |
|---------|---------|---------|----------|
| 场景1：派生密码 | applied 目录加密 | | |
| 场景2：自定义密码 | 弹出密码对话框 | | |
| 场景3：密码错误 | 提示验证失败 | | |
| 场景4：防篡改 | 加载失败 | | |

---

## 日志查看

查看详细日志：

```bash
adb logcat | grep -E "PatchApplication|HotUpdateHelper|ZipPasswordManager"
```

关键日志：

- `Patch is ZIP password protected, decrypting...` - 检测到加密补丁
- `Using custom ZIP password` - 使用自定义密码
- `Using derived ZIP password` - 使用派生密码
- `✓ ZIP password protected patch decrypted` - 解密成功
- `Failed to decrypt ZIP password protected patch` - 解密失败
