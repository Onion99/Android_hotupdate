# ZIP 密码功能测试指南

## 测试环境

- 设备：SKW-A0 - 10 (ADB ID: 9c18cb30)
- 应用版本：v1.1 (已安装)
- 新版本：v1.2 (用于生成补丁)

## 测试步骤

### 测试 1：自定义 ZIP 密码（完整流程）

#### 1. 生成带自定义密码的补丁

1. 打开应用
2. 选择基准 APK：`app-v1.1-debug.apk`
3. 选择新版 APK：`app-v1.2-debug.apk`
4. 点击「生成补丁」
5. 勾选「🔑 ZIP 密码保护」
6. **输入自定义密码**：`test123`
7. 点击「生成」
8. 等待生成完成

**预期结果**：
- 生成补丁文件：`patch_XXXXX.zip`
- 生成密码提示文件：`patch_XXXXX.zip.zippwd`
- 显示：「✓ 补丁生成成功（已添加ZIP密码）！」

#### 2. 应用补丁（输入正确密码）

1. 点击「应用补丁」
2. **弹出密码输入对话框**：「此补丁使用了自定义 ZIP 密码保护，请输入密码：」
3. 输入密码：`test123`
4. 点击「验证并应用」
5. 等待应用完成

**预期结果**：
- 显示进度：「验证 ZIP 密码...」→「解密 ZIP 文件...」→「应用补丁...」
- 显示：「🔥 热更新成功！」
- 标题变为：「🔥 热更新补丁工具 v1.2」（带火焰图标）

#### 3. 应用补丁（输入错误密码）

1. 重新安装 v1.1 版本
2. 点击「应用补丁」
3. 弹出密码输入对话框
4. **输入错误密码**：`wrong`
5. 点击「验证并应用」

**预期结果**：
- 显示错误：「⚠️ ZIP 密码验证失败！密码错误或补丁已被篡改。」
- 弹出对话框：「⚠️ 密码错误」「是否重新输入密码？」
- 点击「重新输入」，重新显示密码输入对话框

### 测试 2：派生密码（自动验证）

#### 1. 生成使用派生密码的补丁

1. 打开应用
2. 选择基准 APK 和新版 APK
3. 点击「生成补丁」
4. 勾选「🔑 ZIP 密码保护」
5. **不输入密码**（留空）
6. 点击「生成」

**预期结果**：
- 生成补丁文件：`patch_XXXXX.zip`
- **不生成** `.zippwd` 文件
- 显示：「✓ 补丁生成成功（已添加ZIP密码）！」

#### 2. 应用补丁（自动验证）

1. 点击「应用补丁」
2. **不弹出密码输入对话框**
3. 自动验证派生密码
4. 应用补丁

**预期结果**：
- 显示进度：「验证 ZIP 密码...」→「解密 ZIP 文件...」→「应用补丁...」
- 显示：「🔥 热更新成功！」
- 标题变为：「🔥 热更新补丁工具 v1.2」

### 测试 3：三重安全防护

#### 1. 生成带签名、ZIP密码和加密的补丁

1. 点击「配置密钥」→「生成新密钥对」
2. 选择基准 APK 和新版 APK
3. 点击「生成补丁」
4. 勾选「🔒 对补丁进行签名」
5. 勾选「🔑 ZIP 密码保护」，输入密码：`secure123`
6. 勾选「🔐 对补丁进行加密」，输入密码：`encrypt456`
7. 点击「生成」

**预期结果**：
- 生成加密补丁：`patch_XXXXX.enc`
- 生成密码提示文件：`patch_XXXXX.enc.zippwd` 和 `patch_XXXXX.enc.pwd`
- 显示：「✓ 补丁生成成功（已签名、ZIP密码并加密）！」

#### 2. 应用三重防护补丁

1. 点击「应用补丁」
2. 弹出 AES 解密密码对话框，输入：`encrypt456`
3. 点击「解密并应用」
4. 弹出 ZIP 密码对话框，输入：`secure123`
5. 点击「验证并应用」

**预期结果**：
- 显示进度：「正在解密补丁...」→「验证 ZIP 密码...」→「解密 ZIP 文件...」→「应用补丁...」
- 显示：「🔥 热更新成功！」

### 测试 4：向后兼容

#### 1. 使用旧版本补丁（无 ZIP 密码）

1. 使用之前生成的未加密补丁（没有 ZIP 密码）
2. 点击「应用补丁」

**预期结果**：
- 跳过 ZIP 密码验证
- 直接应用补丁
- 显示：「🔥 热更新成功！」

## 测试检查点

### ✅ 功能检查

- [ ] 自定义密码：弹出密码输入对话框
- [ ] 派生密码：自动验证，不弹窗
- [ ] 密码正确：应用成功
- [ ] 密码错误：显示错误，提供重新输入选项
- [ ] 三重防护：依次输入 AES 密码和 ZIP 密码
- [ ] 向后兼容：旧版本补丁正常工作

### ✅ UI 检查

- [ ] 密码输入对话框显示正确
- [ ] 进度条显示正确
- [ ] 错误提示清晰
- [ ] 重新输入选项可用

### ✅ 安全检查

- [ ] 密码错误时无法解密
- [ ] 篡改补丁后验证失败
- [ ] 密码提示文件正确生成

## 常见问题

### Q1：密码输入对话框不弹出？

**原因**：补丁使用的是派生密码，没有 `.zippwd` 文件

**解决**：生成补丁时输入自定义密码

### Q2：密码正确但验证失败？

**原因**：
1. 补丁文件损坏
2. 密码输入错误（注意大小写）
3. 使用了错误的补丁文件

**解决**：
1. 重新生成补丁
2. 检查密码是否正确
3. 确认使用的是正确的补丁文件

### Q3：如何查看密码提示？

**方法**：
1. 在文件管理器中找到补丁文件
2. 查看 `.zippwd` 文件内容
3. 文件内容包含密码长度等提示信息

## 测试报告模板

```
测试日期：2026-01-18
测试人员：[姓名]
设备型号：SKW-A0 - 10

测试结果：
- 测试 1（自定义密码）：✅ 通过 / ❌ 失败
- 测试 2（派生密码）：✅ 通过 / ❌ 失败
- 测试 3（三重防护）：✅ 通过 / ❌ 失败
- 测试 4（向后兼容）：✅ 通过 / ❌ 失败

问题记录：
1. [问题描述]
2. [问题描述]

建议：
1. [改进建议]
2. [改进建议]
```

## 快速测试命令

```bash
# 安装应用
adb -s 9c18cb30 install -r app\build\outputs\apk\debug\app-debug.apk

# 查看日志
adb -s 9c18cb30 logcat -s PatchDemo HotUpdateHelper ZipPasswordManager

# 清除应用数据
adb -s 9c18cb30 shell pm clear com.orange.update

# 复制补丁到设备
adb -s 9c18cb30 push patch_XXXXX.zip /sdcard/Download/
adb -s 9c18cb30 push patch_XXXXX.zip.zippwd /sdcard/Download/
```

## 注意事项

1. **密码安全**：测试时使用简单密码，生产环境使用强密码
2. **文件管理**：确保 `.zippwd` 文件和补丁文件在同一目录
3. **设备兼容**：测试不同 Android 版本的兼容性
4. **性能测试**：测试大补丁文件的解密性能
5. **错误处理**：测试各种异常情况（文件损坏、网络中断等）
