import{_ as _e,r as _,a as M,o as ge,M as y,c as S,b as x,f as l,w as a,g as d,q as ve,v as be,e as D,d as v,t as V,j as p,m as we,F as R,h as K,k as Ve,D as ye,y as L,E as c}from"./index-DJLau6vM.js";const xe={class:"patches"},Ue={class:"card-header"},he={style:{display:"flex","flex-direction":"column"}},ke={style:{"font-weight":"bold"}},Ce={style:{"font-size":"12px",color:"#999"}},ze={style:{display:"flex","flex-direction":"column"}},Pe={style:{"font-weight":"bold"}},Be={style:{"font-size":"12px",color:"#999"}},$e={__name:"Patches",setup(De){const F=_(!1),q=_([]),U=_([]),z=_(null),h=_(!1),k=_(!1),P=_(!1),G=_(null),B=_(null),g=_([]),i=M({id:null,description:"",forceUpdate:!1,rolloutPercentage:100,status:"active"}),n=M({app_id:null,version:"",baseVersion:"",description:"",forceUpdate:!1}),b=M({page:1,limit:10,total:0});ge(()=>{H(),w()});const H=async()=>{try{const{data:o}=await y.getApps();U.value=o.filter(e=>e.review_status==="approved")}catch(o){console.error("åŠ è½½åº”ç”¨åˆ—è¡¨å¤±è´¥:",o)}},w=async()=>{var o;try{F.value=!0;const e={page:b.page,limit:b.limit};z.value&&(e.app_id=z.value);const{data:s}=await y.getPatches(e);q.value=s.patches||[],b.total=((o=s.pagination)==null?void 0:o.total)||0}catch(e){console.error("åŠ è½½è¡¥ä¸åˆ—è¡¨å¤±è´¥:",e)}finally{F.value=!1}},J=o=>o<1024?o+" B":o<1024*1024?(o/1024).toFixed(2)+" KB":(o/1024/1024).toFixed(2)+" MB",O=o=>{i.id=o.id,i.description=o.description,i.forceUpdate=o.force_update===1,i.rolloutPercentage=o.rollout_percentage,i.status=o.status,h.value=!0},Q=async()=>{try{await y.updatePatch(i.id,{description:i.description,forceUpdate:i.forceUpdate,rolloutPercentage:i.rolloutPercentage,status:i.status}),c.success("æ›´æ–°æˆåŠŸ"),h.value=!1,w()}catch(o){console.error("æ›´æ–°å¤±è´¥:",o)}},W=async o=>{try{await L.confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¡¥ä¸å—ï¼Ÿ","è­¦å‘Š",{confirmButtonText:"ç¡®å®š",cancelButtonText:"å–æ¶ˆ",type:"warning"}),await y.deletePatch(o.id),c.success("åˆ é™¤æˆåŠŸ"),w()}catch(e){e!=="cancel"&&console.error("åˆ é™¤å¤±è´¥:",e)}},X=()=>{if(U.value.length===0){c.warning("è¯·å…ˆåˆ›å»ºåº”ç”¨");return}n.app_id=null,n.version="",n.baseVersion="",n.description="",n.forceUpdate=!1,B.value=null,k.value=!0},Y=o=>{B.value=o.raw},Z=()=>{c.warning("åªèƒ½ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶")},ee=o=>{g.value=o},le=async o=>{if(g.value.length===0){c.warning("è¯·å…ˆé€‰æ‹©è¡¥ä¸");return}try{let e="",s="";o==="enable"?(e=`ç¡®å®šè¦å¯ç”¨é€‰ä¸­çš„ ${g.value.length} ä¸ªè¡¥ä¸å—ï¼Ÿ`,s="enable"):o==="disable"?(e=`ç¡®å®šè¦åœç”¨é€‰ä¸­çš„ ${g.value.length} ä¸ªè¡¥ä¸å—ï¼Ÿ`,s="disable"):o==="delete"&&(e=`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${g.value.length} ä¸ªè¡¥ä¸å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`,s="delete"),await L.confirm(e,"æ‰¹é‡æ“ä½œ",{confirmButtonText:"ç¡®å®š",cancelButtonText:"å–æ¶ˆ",type:"warning"});const u=g.value.map(r=>r.id);if(s==="delete")await y.post("/patches/batch-delete",{ids:u}),c.success("æ‰¹é‡åˆ é™¤æˆåŠŸ");else{const r=s==="enable"?"active":"inactive";await y.post("/patches/batch-update-status",{ids:u,status:r}),c.success(`æ‰¹é‡${s==="enable"?"å¯ç”¨":"åœç”¨"}æˆåŠŸ`)}g.value=[],w()}catch(e){e!=="cancel"&&(c.error("æ“ä½œå¤±è´¥"),console.error(e))}},te=async()=>{var o,e;if(!n.app_id){c.warning("è¯·é€‰æ‹©åº”ç”¨");return}if(!n.version||!n.baseVersion){c.warning("è¯·å¡«å†™ç‰ˆæœ¬å·å’ŒåŸºç¡€ç‰ˆæœ¬å·");return}if(!B.value){c.warning("è¯·é€‰æ‹©è¡¥ä¸æ–‡ä»¶");return}try{P.value=!0;const s=U.value.find(r=>r.id===n.app_id);if(!s){c.error("æœªæ‰¾åˆ°é€‰ä¸­çš„åº”ç”¨");return}const u=new FormData;u.append("file",B.value),u.append("app_id",n.app_id),u.append("version",n.version),u.append("baseVersion",n.baseVersion),u.append("description",n.description),u.append("forceUpdate",n.forceUpdate),u.append("package_name",s.package_name),u.append("app_id_string",s.app_id),console.log("ðŸ“¤ ä¸Šä¼ è¡¥ä¸ï¼ŒéªŒè¯ä¿¡æ¯:"),console.log("  - åº”ç”¨åç§°:",s.app_name),console.log("  - åŒ…å:",s.package_name),console.log("  - app_id:",s.app_id),await y.uploadPatch(u,r=>{const C=Math.round(r.loaded*100/r.total);console.log("ä¸Šä¼ è¿›åº¦:",C+"%")}),c.success("è¡¥ä¸ä¸Šä¼ æˆåŠŸ"),k.value=!1,w()}catch(s){console.error("ä¸Šä¼ å¤±è´¥:",s),c.error("ä¸Šä¼ å¤±è´¥: "+(((e=(o=s.response)==null?void 0:o.data)==null?void 0:e.error)||s.message))}finally{P.value=!1}};return(o,e)=>{const s=d("arrow-down"),u=d("el-icon"),r=d("el-button"),C=d("el-dropdown-item"),ae=d("el-dropdown-menu"),oe=d("el-dropdown"),A=d("el-option"),E=d("el-select"),ne=d("el-space"),m=d("el-table-column"),de=d("el-tag"),se=d("el-table"),ie=d("el-pagination"),re=d("el-card"),$=d("el-input"),f=d("el-form-item"),N=d("el-switch"),pe=d("el-slider"),T=d("el-radio"),ue=d("el-radio-group"),j=d("el-form"),I=d("el-dialog"),ce=d("el-upload"),me=ve("loading");return x(),S("div",xe,[l(re,null,{header:a(()=>[v("div",Ue,[e[20]||(e[20]=v("span",null,"è¡¥ä¸åˆ—è¡¨",-1)),l(ne,null,{default:a(()=>[g.value.length>0?(x(),D(oe,{key:0,onCommand:le},{dropdown:a(()=>[l(ae,null,{default:a(()=>[l(C,{command:"enable"},{default:a(()=>[...e[16]||(e[16]=[p("æ‰¹é‡å¯ç”¨",-1)])]),_:1}),l(C,{command:"disable"},{default:a(()=>[...e[17]||(e[17]=[p("æ‰¹é‡åœç”¨",-1)])]),_:1}),l(C,{command:"delete",divided:""},{default:a(()=>[...e[18]||(e[18]=[p("æ‰¹é‡åˆ é™¤",-1)])]),_:1})]),_:1})]),default:a(()=>[l(r,{type:"primary"},{default:a(()=>[p(" æ‰¹é‡æ“ä½œ ("+V(g.value.length)+") ",1),l(u,{class:"el-icon--right"},{default:a(()=>[l(s)]),_:1})]),_:1})]),_:1})):we("",!0),l(E,{modelValue:z.value,"onUpdate:modelValue":e[0]||(e[0]=t=>z.value=t),placeholder:"ç­›é€‰åº”ç”¨",clearable:"",onChange:w,style:{width:"250px"}},{default:a(()=>[(x(!0),S(R,null,K(U.value,t=>(x(),D(A,{key:t.id,label:`${t.app_name} (${t.package_name})`,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),l(r,{type:"primary",onClick:X},{default:a(()=>[l(u,null,{default:a(()=>[l(Ve(ye))]),_:1}),e[19]||(e[19]=p(" ä¸Šä¼ è¡¥ä¸ ",-1))]),_:1})]),_:1})])]),default:a(()=>[be((x(),D(se,{data:q.value,onSelectionChange:ee},{default:a(()=>[l(m,{type:"selection",width:"55"}),l(m,{prop:"app_name",label:"åº”ç”¨",width:"200"},{default:a(({row:t})=>[v("div",he,[v("span",ke,V(t.app_name||"æœªçŸ¥åº”ç”¨"),1),v("span",Ce,V(t.package_name||"N/A"),1)])]),_:1}),l(m,{prop:"version",label:"ç‰ˆæœ¬",width:"100"}),l(m,{prop:"base_version",label:"åŸºç¡€ç‰ˆæœ¬",width:"100"}),l(m,{prop:"description",label:"æè¿°","show-overflow-tooltip":""}),l(m,{prop:"file_size",label:"å¤§å°",width:"100"},{default:a(({row:t})=>[p(V(J(t.file_size)),1)]),_:1}),l(m,{prop:"download_count",label:"ä¸‹è½½æ¬¡æ•°",width:"100"}),l(m,{prop:"status",label:"çŠ¶æ€",width:"100"},{default:a(({row:t})=>[l(de,{type:t.status==="active"?"success":"info"},{default:a(()=>[p(V(t.status==="active"?"å¯ç”¨":"ç¦ç”¨"),1)]),_:2},1032,["type"])]),_:1}),l(m,{prop:"created_at",label:"åˆ›å»ºæ—¶é—´",width:"180"}),l(m,{label:"æ“ä½œ",width:"200",fixed:"right"},{default:a(({row:t})=>[l(r,{size:"small",onClick:fe=>O(t)},{default:a(()=>[...e[21]||(e[21]=[p("ç¼–è¾‘",-1)])]),_:1},8,["onClick"]),l(r,{size:"small",type:"danger",onClick:fe=>W(t)},{default:a(()=>[...e[22]||(e[22]=[p("åˆ é™¤",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[me,F.value]]),l(ie,{"current-page":b.page,"onUpdate:currentPage":e[1]||(e[1]=t=>b.page=t),"page-size":b.limit,"onUpdate:pageSize":e[2]||(e[2]=t=>b.limit=t),total:b.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:w,onSizeChange:w,style:{"margin-top":"20px","justify-content":"flex-end"}},null,8,["current-page","page-size","total"])]),_:1}),l(I,{modelValue:h.value,"onUpdate:modelValue":e[8]||(e[8]=t=>h.value=t),title:"ç¼–è¾‘è¡¥ä¸",width:"500px"},{footer:a(()=>[l(r,{onClick:e[7]||(e[7]=t=>h.value=!1)},{default:a(()=>[...e[25]||(e[25]=[p("å–æ¶ˆ",-1)])]),_:1}),l(r,{type:"primary",onClick:Q},{default:a(()=>[...e[26]||(e[26]=[p("ç¡®å®š",-1)])]),_:1})]),default:a(()=>[l(j,{model:i,"label-width":"100px"},{default:a(()=>[l(f,{label:"æè¿°"},{default:a(()=>[l($,{modelValue:i.description,"onUpdate:modelValue":e[3]||(e[3]=t=>i.description=t),type:"textarea",rows:3},null,8,["modelValue"])]),_:1}),l(f,{label:"å¼ºåˆ¶æ›´æ–°"},{default:a(()=>[l(N,{modelValue:i.forceUpdate,"onUpdate:modelValue":e[4]||(e[4]=t=>i.forceUpdate=t)},null,8,["modelValue"])]),_:1}),l(f,{label:"ç°åº¦ç™¾åˆ†æ¯”"},{default:a(()=>[l(pe,{modelValue:i.rolloutPercentage,"onUpdate:modelValue":e[5]||(e[5]=t=>i.rolloutPercentage=t),min:0,max:100},null,8,["modelValue"])]),_:1}),l(f,{label:"çŠ¶æ€"},{default:a(()=>[l(ue,{modelValue:i.status,"onUpdate:modelValue":e[6]||(e[6]=t=>i.status=t)},{default:a(()=>[l(T,{label:"active"},{default:a(()=>[...e[23]||(e[23]=[p("å¯ç”¨",-1)])]),_:1}),l(T,{label:"inactive"},{default:a(()=>[...e[24]||(e[24]=[p("ç¦ç”¨",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(I,{modelValue:k.value,"onUpdate:modelValue":e[15]||(e[15]=t=>k.value=t),title:"ä¸Šä¼ è¡¥ä¸",width:"600px"},{footer:a(()=>[l(r,{onClick:e[14]||(e[14]=t=>k.value=!1)},{default:a(()=>[...e[29]||(e[29]=[p("å–æ¶ˆ",-1)])]),_:1}),l(r,{type:"primary",onClick:te,loading:P.value},{default:a(()=>[p(V(P.value?"ä¸Šä¼ ä¸­...":"ç¡®å®šä¸Šä¼ "),1)]),_:1},8,["loading"])]),default:a(()=>[l(j,{model:n,"label-width":"100px"},{default:a(()=>[l(f,{label:"é€‰æ‹©åº”ç”¨",required:""},{default:a(()=>[l(E,{modelValue:n.app_id,"onUpdate:modelValue":e[9]||(e[9]=t=>n.app_id=t),placeholder:"è¯·é€‰æ‹©åº”ç”¨",style:{width:"100%"}},{default:a(()=>[(x(!0),S(R,null,K(U.value,t=>(x(),D(A,{key:t.id,label:`${t.app_name} (${t.package_name})`,value:t.id},{default:a(()=>[v("div",ze,[v("span",Pe,V(t.app_name),1),v("span",Be,V(t.package_name),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(f,{label:"è¡¥ä¸ç‰ˆæœ¬",required:""},{default:a(()=>[l($,{modelValue:n.version,"onUpdate:modelValue":e[10]||(e[10]=t=>n.version=t),placeholder:"ä¾‹å¦‚: 1.0.1"},null,8,["modelValue"])]),_:1}),l(f,{label:"åŸºç¡€ç‰ˆæœ¬",required:""},{default:a(()=>[l($,{modelValue:n.baseVersion,"onUpdate:modelValue":e[11]||(e[11]=t=>n.baseVersion=t),placeholder:"ä¾‹å¦‚: 1.0.0"},null,8,["modelValue"])]),_:1}),l(f,{label:"æè¿°"},{default:a(()=>[l($,{modelValue:n.description,"onUpdate:modelValue":e[12]||(e[12]=t=>n.description=t),type:"textarea",rows:3,placeholder:"è¡¥ä¸è¯´æ˜Ž"},null,8,["modelValue"])]),_:1}),l(f,{label:"å¼ºåˆ¶æ›´æ–°"},{default:a(()=>[l(N,{modelValue:n.forceUpdate,"onUpdate:modelValue":e[13]||(e[13]=t=>n.forceUpdate=t)},null,8,["modelValue"])]),_:1}),l(f,{label:"è¡¥ä¸æ–‡ä»¶",required:""},{default:a(()=>[l(ce,{ref_key:"uploadRef",ref:G,"auto-upload":!1,limit:1,accept:".zip","on-change":Y,"on-exceed":Z},{tip:a(()=>[...e[28]||(e[28]=[v("div",{class:"el-upload__tip"},"åªèƒ½ä¸Šä¼  zip æ–‡ä»¶ï¼Œä¸”ä¸è¶…è¿‡ 100MB",-1)])]),default:a(()=>[l(r,{type:"primary"},{default:a(()=>[...e[27]||(e[27]=[p("é€‰æ‹©æ–‡ä»¶",-1)])]),_:1})]),_:1},512)]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Me=_e($e,[["__scopeId","data-v-dffa0920"]]);export{Me as default};
