import{_ as oe,r as x,a as q,c as re,b as _,f as t,w as l,g as d,M as c,q as ie,v as de,e as v,j as n,t as m,d as C,k as ue,p as pe,m as I,E as i,y as b}from"./index-C4_VDvs8.js";const ce={class:"users"},me={class:"card-header"},fe={style:{"margin-bottom":"16px"}},_e={style:{"margin-bottom":"16px"}},ye={__name:"Users",setup(ve){const U=x(!1),S=x([]),k=x(!1),T=x(!1),P=x(),$=x("info"),y=x(null),r=q({user:null,apps:[],patches:[]}),f=q({username:"",password:"",email:"",role:"user"}),F={username:[{required:!0,message:"请输入用户名",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"}],email:[{type:"email",message:"请输入正确的邮箱",trigger:"blur"}]},h=async()=>{try{U.value=!0;const{data:s}=await c.getUsers();S.value=s||[]}catch(s){console.error("加载用户列表失败:",s)}finally{U.value=!1}},R=async()=>{try{await P.value.validate(),await c.createUser(f),i.success("创建成功"),k.value=!1,h()}catch(s){console.error("创建失败:",s)}},j=async s=>{try{await b.confirm("确定要删除这个用户吗？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await c.deleteUser(s.id),i.success("删除成功"),h()}catch(e){e!=="cancel"&&console.error("删除失败:",e)}},K=async s=>{try{await b.confirm(`确定要封禁用户 "${s.username}" 吗？封禁后该用户将无法登录。`,"封禁用户",{confirmButtonText:"确定封禁",cancelButtonText:"取消",type:"warning"}),await c.updateUserStatus(s.id,{status:"banned"}),i.success("用户已封禁"),h()}catch(e){e!=="cancel"&&i.error("封禁失败")}},G=async s=>{try{await b.confirm(`确定要解封用户 "${s.username}" 吗？`,"解封用户",{confirmButtonText:"确定解封",cancelButtonText:"取消",type:"info"}),await c.updateUserStatus(s.id,{status:"active"}),i.success("用户已解封"),h()}catch(e){e!=="cancel"&&i.error("解封失败")}},w=async s=>{try{y.value=s.id;const{data:e}=await c.getUserDetail(s.id);r.user=e.user,r.apps=e.apps,r.patches=e.patches,T.value=!0,$.value="info"}catch{i.error("加载用户详情失败")}},H=async()=>{try{await b.confirm("确定要封禁该用户的所有应用吗？","封禁应用",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await c.banUserApps(y.value),i.success("应用已全部封禁"),w({id:y.value})}catch(s){s!=="cancel"&&i.error("封禁失败")}},J=async()=>{try{await b.confirm("确定要删除该用户的所有补丁吗？此操作不可恢复！","删除补丁",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"error"});const{data:s}=await c.deleteUserPatches(y.value);i.success(`已删除 ${s.count} 个补丁`),w({id:y.value})}catch(s){s!=="cancel"&&i.error("删除失败")}},L=async s=>{try{await b.confirm(`确定要封禁应用 "${s.app_name}" 吗？`,"封禁应用",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await c.updateAppStatus(s.id,"inactive"),i.success("应用已封禁"),w({id:y.value})}catch(e){e!=="cancel"&&i.error("封禁失败")}},O=async s=>{try{await b.confirm(`确定要解封应用 "${s.app_name}" 吗？`,"解封应用",{confirmButtonText:"确定",cancelButtonText:"取消",type:"info"}),await c.updateAppStatus(s.id,"active"),i.success("应用已解封"),w({id:y.value})}catch(e){e!=="cancel"&&i.error("解封失败")}},Q=async s=>{try{await b.confirm(`确定要封禁补丁 "${s.version}" 吗？`,"封禁补丁",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await c.updatePatchStatus(s.id,"inactive"),i.success("补丁已封禁"),w({id:y.value})}catch(e){e!=="cancel"&&i.error("封禁失败")}},W=async s=>{try{await b.confirm(`确定要解封补丁 "${s.version}" 吗？`,"解封补丁",{confirmButtonText:"确定",cancelButtonText:"取消",type:"info"}),await c.updatePatchStatus(s.id,"active"),i.success("补丁已解封"),w({id:y.value})}catch(e){e!=="cancel"&&i.error("解封失败")}},X=s=>s<1024?s+" B":s<1024*1024?(s/1024).toFixed(2)+" KB":(s/1024/1024).toFixed(2)+" MB";return h(),(s,e)=>{const Y=d("el-icon"),u=d("el-button"),o=d("el-table-column"),g=d("el-tag"),Z=d("el-space"),z=d("el-table"),ee=d("el-card"),D=d("el-input"),V=d("el-form-item"),E=d("el-radio"),te=d("el-radio-group"),ae=d("el-form"),M=d("el-dialog"),B=d("el-descriptions-item"),le=d("el-descriptions"),A=d("el-tab-pane"),N=d("el-empty"),se=d("el-tabs"),ne=ie("loading");return _(),re("div",ce,[t(ee,null,{header:l(()=>[C("div",me,[e[10]||(e[10]=C("span",null,"用户管理",-1)),t(u,{type:"primary",onClick:e[0]||(e[0]=a=>k.value=!0)},{default:l(()=>[t(Y,null,{default:l(()=>[t(ue(pe))]),_:1}),e[9]||(e[9]=n(" 添加用户 ",-1))]),_:1})])]),default:l(()=>[de((_(),v(z,{data:S.value},{default:l(()=>[t(o,{prop:"id",label:"ID",width:"80"}),t(o,{prop:"username",label:"用户名",width:"150"}),t(o,{prop:"email",label:"邮箱",width:"200"}),t(o,{prop:"role",label:"角色",width:"100"},{default:l(({row:a})=>[t(g,{type:a.role==="admin"?"danger":"info"},{default:l(()=>[n(m(a.role==="admin"?"管理员":"普通用户"),1)]),_:2},1032,["type"])]),_:1}),t(o,{label:"应用/补丁",width:"120"},{default:l(({row:a})=>[t(Z,null,{default:l(()=>[t(g,{type:"primary"},{default:l(()=>[n(m(a.app_count||0)+" 应用",1)]),_:2},1024),t(g,{type:"success"},{default:l(()=>[n(m(a.patch_count||0)+" 补丁",1)]),_:2},1024)]),_:2},1024)]),_:1}),t(o,{prop:"status",label:"状态",width:"100"},{default:l(({row:a})=>[t(g,{type:a.status==="active"?"success":"danger"},{default:l(()=>[n(m(a.status==="active"?"正常":"已封禁"),1)]),_:2},1032,["type"])]),_:1}),t(o,{prop:"created_at",label:"创建时间",width:"180"}),t(o,{label:"操作",width:"300",fixed:"right"},{default:l(({row:a})=>[t(u,{size:"small",onClick:p=>w(a)},{default:l(()=>[...e[11]||(e[11]=[n(" 查看详情 ",-1)])]),_:1},8,["onClick"]),a.status==="active"?(_(),v(u,{key:0,size:"small",type:"warning",onClick:p=>K(a),disabled:a.role==="admin"},{default:l(()=>[...e[12]||(e[12]=[n(" 封禁 ",-1)])]),_:1},8,["onClick","disabled"])):(_(),v(u,{key:1,size:"small",type:"success",onClick:p=>G(a)},{default:l(()=>[...e[13]||(e[13]=[n(" 解封 ",-1)])]),_:1},8,["onClick"])),t(u,{size:"small",type:"danger",onClick:p=>j(a),disabled:a.role==="admin"},{default:l(()=>[...e[14]||(e[14]=[n(" 删除 ",-1)])]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["data"])),[[ne,U.value]])]),_:1}),t(M,{modelValue:k.value,"onUpdate:modelValue":e[6]||(e[6]=a=>k.value=a),title:"添加用户",width:"500px"},{footer:l(()=>[t(u,{onClick:e[5]||(e[5]=a=>k.value=!1)},{default:l(()=>[...e[17]||(e[17]=[n("取消",-1)])]),_:1}),t(u,{type:"primary",onClick:R},{default:l(()=>[...e[18]||(e[18]=[n("确定",-1)])]),_:1})]),default:l(()=>[t(ae,{model:f,rules:F,ref_key:"formRef",ref:P,"label-width":"80px"},{default:l(()=>[t(V,{label:"用户名",prop:"username"},{default:l(()=>[t(D,{modelValue:f.username,"onUpdate:modelValue":e[1]||(e[1]=a=>f.username=a)},null,8,["modelValue"])]),_:1}),t(V,{label:"密码",prop:"password"},{default:l(()=>[t(D,{modelValue:f.password,"onUpdate:modelValue":e[2]||(e[2]=a=>f.password=a),type:"password"},null,8,["modelValue"])]),_:1}),t(V,{label:"邮箱",prop:"email"},{default:l(()=>[t(D,{modelValue:f.email,"onUpdate:modelValue":e[3]||(e[3]=a=>f.email=a)},null,8,["modelValue"])]),_:1}),t(V,{label:"角色",prop:"role"},{default:l(()=>[t(te,{modelValue:f.role,"onUpdate:modelValue":e[4]||(e[4]=a=>f.role=a)},{default:l(()=>[t(E,{label:"user"},{default:l(()=>[...e[15]||(e[15]=[n("普通用户",-1)])]),_:1}),t(E,{label:"admin"},{default:l(()=>[...e[16]||(e[16]=[n("管理员",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(M,{modelValue:T.value,"onUpdate:modelValue":e[8]||(e[8]=a=>T.value=a),title:"用户详情",width:"900px"},{default:l(()=>[t(se,{modelValue:$.value,"onUpdate:modelValue":e[7]||(e[7]=a=>$.value=a)},{default:l(()=>[t(A,{label:"基本信息",name:"info"},{default:l(()=>[t(le,{column:2,border:""},{default:l(()=>[t(B,{label:"用户名"},{default:l(()=>{var a;return[n(m((a=r.user)==null?void 0:a.username),1)]}),_:1}),t(B,{label:"邮箱"},{default:l(()=>{var a;return[n(m(((a=r.user)==null?void 0:a.email)||"未设置"),1)]}),_:1}),t(B,{label:"角色"},{default:l(()=>{var a;return[t(g,{type:((a=r.user)==null?void 0:a.role)==="admin"?"danger":"info"},{default:l(()=>{var p;return[n(m(((p=r.user)==null?void 0:p.role)==="admin"?"管理员":"普通用户"),1)]}),_:1},8,["type"])]}),_:1}),t(B,{label:"状态"},{default:l(()=>{var a;return[t(g,{type:((a=r.user)==null?void 0:a.status)==="active"?"success":"danger"},{default:l(()=>{var p;return[n(m(((p=r.user)==null?void 0:p.status)==="active"?"正常":"已封禁"),1)]}),_:1},8,["type"])]}),_:1}),t(B,{label:"创建时间",span:2},{default:l(()=>{var a;return[n(m((a=r.user)==null?void 0:a.created_at),1)]}),_:1})]),_:1})]),_:1}),t(A,{label:"应用列表",name:"apps"},{default:l(()=>[C("div",fe,[t(u,{type:"warning",size:"small",onClick:H,disabled:!r.apps||r.apps.length===0},{default:l(()=>[...e[19]||(e[19]=[n(" 封禁所有应用 ",-1)])]),_:1},8,["disabled"])]),t(z,{data:r.apps,"max-height":"400"},{default:l(()=>[t(o,{prop:"app_name",label:"应用名称",width:"150"}),t(o,{prop:"package_name",label:"包名",width:"200"}),t(o,{prop:"patch_count",label:"补丁数",width:"100"}),t(o,{prop:"status",label:"状态",width:"100"},{default:l(({row:a})=>[t(g,{type:a.status==="active"?"success":"danger"},{default:l(()=>[n(m(a.status==="active"?"活跃":"已封禁"),1)]),_:2},1032,["type"])]),_:1}),t(o,{prop:"created_at",label:"创建时间",width:"180"}),t(o,{label:"操作",width:"150",fixed:"right"},{default:l(({row:a})=>[a.status==="active"?(_(),v(u,{key:0,size:"small",type:"warning",onClick:p=>L(a)},{default:l(()=>[...e[20]||(e[20]=[n(" 封禁 ",-1)])]),_:1},8,["onClick"])):(_(),v(u,{key:1,size:"small",type:"success",onClick:p=>O(a)},{default:l(()=>[...e[21]||(e[21]=[n(" 解封 ",-1)])]),_:1},8,["onClick"]))]),_:1})]),_:1},8,["data"]),!r.apps||r.apps.length===0?(_(),v(N,{key:0,description:"暂无应用"})):I("",!0)]),_:1}),t(A,{label:"补丁列表",name:"patches"},{default:l(()=>[C("div",_e,[t(u,{type:"danger",size:"small",onClick:J,disabled:!r.patches||r.patches.length===0},{default:l(()=>[...e[22]||(e[22]=[n(" 删除所有补丁 ",-1)])]),_:1},8,["disabled"])]),t(z,{data:r.patches,"max-height":"400"},{default:l(()=>[t(o,{prop:"app_name",label:"所属应用",width:"150"}),t(o,{prop:"version",label:"版本",width:"100"}),t(o,{prop:"base_version",label:"基础版本",width:"100"}),t(o,{prop:"description",label:"描述","show-overflow-tooltip":""}),t(o,{prop:"file_size",label:"大小",width:"100"},{default:l(({row:a})=>[n(m(X(a.file_size)),1)]),_:1}),t(o,{prop:"status",label:"状态",width:"100"},{default:l(({row:a})=>[t(g,{type:a.status==="active"?"success":"danger"},{default:l(()=>[n(m(a.status==="active"?"启用":"已封禁"),1)]),_:2},1032,["type"])]),_:1}),t(o,{prop:"created_at",label:"创建时间",width:"180"}),t(o,{label:"操作",width:"150",fixed:"right"},{default:l(({row:a})=>[a.status==="active"?(_(),v(u,{key:0,size:"small",type:"warning",onClick:p=>Q(a)},{default:l(()=>[...e[23]||(e[23]=[n(" 封禁 ",-1)])]),_:1},8,["onClick"])):(_(),v(u,{key:1,size:"small",type:"success",onClick:p=>W(a)},{default:l(()=>[...e[24]||(e[24]=[n(" 解封 ",-1)])]),_:1},8,["onClick"]))]),_:1})]),_:1},8,["data"]),!r.patches||r.patches.length===0?(_(),v(N,{key:0,description:"暂无补丁"})):I("",!0)]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])])}}},ge=oe(ye,[["__scopeId","data-v-eafbfdd7"]]);export{ge as default};
