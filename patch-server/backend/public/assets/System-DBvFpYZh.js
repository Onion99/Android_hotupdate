import{_ as ze,r as k,a as O,o as Ve,c as Me,b as y,d as o,f as l,w as t,g as u,M as f,E as d,q as Se,v as F,e as v,j as s,t as m,k as T,J as N,m as M,T as $e,U as ie,y as S}from"./index-BnZprTwO.js";const Ue={class:"system-container"},je={style:{display:"flex","justify-content":"space-between","align-items":"center"}},De={style:{"font-family":"monospace"}},Ee={style:{display:"flex","justify-content":"space-between","align-items":"center"}},Le={style:{display:"flex","justify-content":"space-between","align-items":"center"}},Pe={style:{display:"flex","justify-content":"space-between","align-items":"center"}},Ne={style:{"margin-left":"12px",color:"#999","font-size":"14px"}},We={style:{display:"flex","justify-content":"space-between","align-items":"center"}},Re={__name:"System",setup(Ae){const Q=k("tasks"),C=k(!1),W=k(!1),X=k([]),R=k([]),B=O({logs:!1,downloads:!1}),c=k({}),$=k(!1),D=k(""),U=O({email:!1,webhook:!1}),w=O({app_review_enabled:!1,auto_approve_admin:!0}),A=k([]),E=k(!1),re={backup:"数据备份","clean-logs":"日志清理","clean-downloads":"记录清理"},j=a=>re[a]||a,de=(a,e)=>({backup:"每天凌晨 2 点自动备份数据库和文件","clean-logs":"每周日凌晨 3 点清理 30 天前的日志","clean-downloads":"每月 1 号凌晨 4 点清理 90 天前的下载记录"})[a]||`定时执行 (${e})`,L=async()=>{try{C.value=!0;const{data:a}=await f.getTasks();X.value=a.tasks}catch{d.error("加载任务列表失败")}finally{C.value=!1}},ue=async a=>{try{await f.startTask(a),d.success(`任务 ${j(a)} 已启动`),L()}catch{d.error("启动任务失败")}},pe=async a=>{try{await f.stopTask(a),d.success(`任务 ${j(a)} 已停止`),L()}catch{d.error("停止任务失败")}},P=async()=>{try{C.value=!0;const{data:a}=await f.getBackups();R.value=a.backups}catch{d.error("加载备份列表失败")}finally{C.value=!1}},ce=async()=>{try{W.value=!0,await f.runBackup(),d.success("备份完成"),P()}catch{d.error("备份失败")}finally{W.value=!1}},fe=async a=>{try{await f.deleteBackup(a),d.success("备份已删除"),P()}catch{d.error("删除失败")}},me=async a=>{var e,i;try{await S.confirm(`确定要从备份 "${a}" 恢复数据吗？

⚠️ 警告：
1. 当前数据将被覆盖
2. 恢复后需要重启服务
3. 恢复过程中请勿操作系统

建议先备份当前数据！`,"确认恢复",{confirmButtonText:"确定恢复",cancelButtonText:"取消",type:"warning",dangerouslyUseHTMLString:!0});const{data:r}=await f.restoreBackup(a);S.alert(r.message+`

`+(r.warning||""),"恢复任务已启动",{confirmButtonText:"知道了",type:"success"})}catch(r){r!=="cancel"&&d.error("恢复失败: "+(((i=(e=r.response)==null?void 0:e.data)==null?void 0:i.error)||r.message))}},_e=async()=>{try{await S.confirm("确定要清理 30 天前的操作日志吗？此操作不可恢复。","确认清理",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),B.logs=!0,await f.cleanLogs(),d.success("日志清理完成")}catch(a){a!=="cancel"&&d.error("清理失败")}finally{B.logs=!1}},ye=async()=>{try{await S.confirm("确定要清理 90 天前的下载记录吗？此操作不可恢复。","确认清理",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),B.downloads=!0,await f.cleanDownloads(),d.success("下载记录清理完成")}catch(a){a!=="cancel"&&d.error("清理失败")}finally{B.downloads=!1}},ve=a=>{if(a===0)return"0 B";const e=1024,i=["B","KB","MB","GB"],r=Math.floor(Math.log(a)/Math.log(e));return Math.round(a/Math.pow(e,r)*100)/100+" "+i[r]},be=a=>new Date(a).toLocaleString("zh-CN"),Y=async()=>{var a;try{const{data:e}=await f.getNotificationConfig();c.value=e}catch(e){((a=e.response)==null?void 0:a.status)!==404&&console.error("加载通知配置失败:",e)}},ge=async()=>{var a,e;if(!D.value){d.warning("请输入邮箱地址");return}try{U.email=!0,await f.testEmail(D.value),d.success("测试邮件已发送，请检查收件箱"),$.value=!1}catch(i){d.error("发送失败: "+(((e=(a=i.response)==null?void 0:a.data)==null?void 0:e.error)||i.message))}finally{U.email=!1}},we=async()=>{var a,e;try{U.webhook=!0,await f.testWebhook(),d.success("Webhook 测试请求已发送")}catch(i){d.error("发送失败: "+(((e=(a=i.response)==null?void 0:a.data)==null?void 0:e.error)||i.message))}finally{U.webhook=!1}},Z=async()=>{var a,e;try{const{data:i}=await f.getSystemConfig();w.app_review_enabled=((a=i.app_review_enabled)==null?void 0:a.value)==="true",w.auto_approve_admin=((e=i.auto_approve_admin)==null?void 0:e.value)==="true"}catch(i){console.error("加载审核设置失败:",i)}},ee=async()=>{try{await f.batchUpdateSystemConfig({app_review_enabled:w.app_review_enabled?"true":"false",auto_approve_admin:w.auto_approve_admin?"true":"false"}),d.success("设置已保存")}catch{d.error("保存失败"),Z()}},H=async()=>{try{E.value=!0;const{data:a}=await f.getPendingApps();A.value=a||[]}catch(a){console.error("加载待审核应用失败:",a)}finally{E.value=!1}},le=async(a,e)=>{try{let i="";if(e==="reject"){const{value:r}=await S.prompt("请输入拒绝原因","拒绝审核",{confirmButtonText:"确定",cancelButtonText:"取消",inputPattern:/.+/,inputErrorMessage:"请输入拒绝原因"});i=r}else await S.confirm(`确定要通过应用 "${a.app_name}" 的审核吗？`,"通过审核",{confirmButtonText:"确定",cancelButtonText:"取消",type:"success"});await f.reviewApp(a.id,e,i),d.success(e==="approve"?"审核通过":"已拒绝"),H()}catch(i){i!=="cancel"&&d.error("操作失败")}};return Ve(()=>{L(),P(),Y(),Z(),H()}),(a,e)=>{const i=u("el-icon"),r=u("el-button"),h=u("el-tag"),_=u("el-table-column"),q=u("el-table"),x=u("el-card"),z=u("el-tab-pane"),ke=u("el-popconfirm"),te=u("el-empty"),G=u("el-alert"),ae=u("el-space"),V=u("el-descriptions-item"),xe=u("el-descriptions"),Ce=u("el-divider"),ne=u("el-switch"),I=u("el-form-item"),oe=u("el-form"),Te=u("el-tabs"),Be=u("el-input"),he=u("el-dialog"),J=Se("loading");return y(),Me("div",Ue,[e[33]||(e[33]=o("h2",null,"系统管理",-1)),l(Te,{modelValue:Q.value,"onUpdate:modelValue":e[3]||(e[3]=n=>Q.value=n)},{default:t(()=>[l(z,{label:"定时任务",name:"tasks"},{default:t(()=>[l(x,null,{header:t(()=>[o("div",je,[e[8]||(e[8]=o("span",null,"定时任务列表",-1)),l(r,{size:"small",onClick:L},{default:t(()=>[l(i,null,{default:t(()=>[l(T(N))]),_:1}),e[7]||(e[7]=s(" 刷新 ",-1))]),_:1})])]),default:t(()=>[F((y(),v(q,{data:X.value},{default:t(()=>[l(_,{prop:"name",label:"任务名称",width:"200"},{default:t(({row:n})=>[n.name==="backup"?(y(),v(h,{key:0,type:"primary"},{default:t(()=>[s(m(j(n.name)),1)]),_:2},1024)):n.name==="clean-logs"?(y(),v(h,{key:1,type:"warning"},{default:t(()=>[s(m(j(n.name)),1)]),_:2},1024)):(y(),v(h,{key:2,type:"info"},{default:t(()=>[s(m(j(n.name)),1)]),_:2},1024))]),_:1}),l(_,{prop:"schedule",label:"执行时间",width:"150"},{default:t(({row:n})=>[o("span",De,m(n.schedule),1)]),_:1}),l(_,{label:"说明"},{default:t(({row:n})=>[s(m(de(n.name,n.schedule)),1)]),_:1}),l(_,{prop:"enabled",label:"状态",width:"100"},{default:t(({row:n})=>[l(h,{type:n.enabled?"success":"info"},{default:t(()=>[s(m(n.enabled?"运行中":"已停止"),1)]),_:2},1032,["type"])]),_:1}),l(_,{label:"操作",width:"150"},{default:t(({row:n})=>[n.enabled?(y(),v(r,{key:1,size:"small",type:"warning",onClick:b=>pe(n.name)},{default:t(()=>[...e[10]||(e[10]=[s(" 停止 ",-1)])]),_:1},8,["onClick"])):(y(),v(r,{key:0,size:"small",type:"success",onClick:b=>ue(n.name)},{default:t(()=>[...e[9]||(e[9]=[s(" 启动 ",-1)])]),_:1},8,["onClick"]))]),_:1})]),_:1},8,["data"])),[[J,C.value]])]),_:1})]),_:1}),l(z,{label:"备份管理",name:"backups"},{default:t(()=>[l(x,null,{header:t(()=>[o("div",Ee,[e[13]||(e[13]=o("span",null,"备份文件列表",-1)),o("div",null,[l(r,{size:"small",type:"primary",onClick:ce,loading:W.value},{default:t(()=>[l(i,null,{default:t(()=>[l(T($e))]),_:1}),e[11]||(e[11]=s(" 立即备份 ",-1))]),_:1},8,["loading"]),l(r,{size:"small",onClick:P},{default:t(()=>[l(i,null,{default:t(()=>[l(T(N))]),_:1}),e[12]||(e[12]=s(" 刷新 ",-1))]),_:1})])])]),default:t(()=>[F((y(),v(q,{data:R.value},{default:t(()=>[l(_,{prop:"name",label:"文件名"}),l(_,{prop:"size",label:"大小",width:"120"},{default:t(({row:n})=>[s(m(ve(n.size)),1)]),_:1}),l(_,{prop:"created",label:"创建时间",width:"180"},{default:t(({row:n})=>[s(m(be(n.created)),1)]),_:1}),l(_,{label:"操作",width:"180"},{default:t(({row:n})=>[l(r,{size:"small",type:"primary",onClick:b=>me(n.name)},{default:t(()=>[...e[14]||(e[14]=[s(" 恢复 ",-1)])]),_:1},8,["onClick"]),l(ke,{title:"确定要删除这个备份吗？",onConfirm:b=>fe(n.name)},{reference:t(()=>[l(r,{size:"small",type:"danger"},{default:t(()=>[...e[15]||(e[15]=[s("删除",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data"])),[[J,C.value]]),R.value.length===0&&!C.value?(y(),v(te,{key:0,description:"暂无备份文件"})):M("",!0)]),_:1})]),_:1}),l(z,{label:"数据清理",name:"clean"},{default:t(()=>[l(x,null,{default:t(()=>[l(G,{title:"数据清理说明",type:"info",closable:!1,style:{"margin-bottom":"20px"}},{default:t(()=>[...e[16]||(e[16]=[o("ul",{style:{margin:"0","padding-left":"20px"}},[o("li",null,"清理日志：删除 30 天前的操作日志"),o("li",null,"清理下载记录：删除 90 天前的下载记录"),o("li",null,"清理操作不可恢复，请谨慎操作")],-1)])]),_:1}),l(ae,{direction:"vertical",size:20,style:{width:"100%"}},{default:t(()=>[l(x,{shadow:"hover"},{default:t(()=>[o("div",Le,[e[18]||(e[18]=o("div",null,[o("h3",{style:{margin:"0 0 8px 0"}},"清理操作日志"),o("p",{style:{margin:"0",color:"#999","font-size":"14px"}}," 删除 30 天前的操作日志，释放数据库空间 ")],-1)),l(r,{type:"warning",onClick:_e,loading:B.logs},{default:t(()=>[l(i,null,{default:t(()=>[l(T(ie))]),_:1}),e[17]||(e[17]=s(" 清理日志 ",-1))]),_:1},8,["loading"])])]),_:1}),l(x,{shadow:"hover"},{default:t(()=>[o("div",Pe,[e[20]||(e[20]=o("div",null,[o("h3",{style:{margin:"0 0 8px 0"}},"清理下载记录"),o("p",{style:{margin:"0",color:"#999","font-size":"14px"}}," 删除 90 天前的下载记录，释放数据库空间 ")],-1)),l(r,{type:"warning",onClick:ye,loading:B.downloads},{default:t(()=>[l(i,null,{default:t(()=>[l(T(ie))]),_:1}),e[19]||(e[19]=s(" 清理记录 ",-1))]),_:1},8,["loading"])])]),_:1})]),_:1})]),_:1})]),_:1}),l(z,{label:"通知配置",name:"notifications"},{default:t(()=>[l(x,null,{default:t(()=>[l(G,{title:"通知说明",type:"info",closable:!1,style:{"margin-bottom":"20px"}},{default:t(()=>[...e[21]||(e[21]=[o("ul",{style:{margin:"0","padding-left":"20px"}},[o("li",null,"邮件通知：通过 SMTP 发送邮件"),o("li",null,"Webhook 通知：发送 HTTP POST 请求到指定 URL"),o("li",null,"配置需要在 .env 文件中设置")],-1)])]),_:1}),l(xe,{column:1,border:""},{default:t(()=>{var n,b,K,se;return[l(V,{label:"邮件通知"},{default:t(()=>{var p;return[l(h,{type:(p=c.value.email)!=null&&p.enabled?"success":"info"},{default:t(()=>{var g;return[s(m((g=c.value.email)!=null&&g.enabled?"已启用":"未启用"),1)]}),_:1},8,["type"])]}),_:1}),(n=c.value.email)!=null&&n.enabled?(y(),v(V,{key:0,label:"SMTP 服务器"},{default:t(()=>{var p,g;return[s(m((p=c.value.email)==null?void 0:p.host)+":"+m((g=c.value.email)==null?void 0:g.port),1)]}),_:1})):M("",!0),(b=c.value.email)!=null&&b.enabled?(y(),v(V,{key:1,label:"发件人"},{default:t(()=>{var p;return[s(m((p=c.value.email)==null?void 0:p.from),1)]}),_:1})):M("",!0),(K=c.value.email)!=null&&K.enabled?(y(),v(V,{key:2,label:"收件人"},{default:t(()=>{var p,g;return[s(m(((g=(p=c.value.email)==null?void 0:p.recipients)==null?void 0:g.join(", "))||"未配置"),1)]}),_:1})):M("",!0),l(V,{label:"Webhook 通知"},{default:t(()=>{var p;return[l(h,{type:(p=c.value.webhook)!=null&&p.enabled?"success":"info"},{default:t(()=>{var g;return[s(m((g=c.value.webhook)!=null&&g.enabled?"已启用":"未启用"),1)]}),_:1},8,["type"])]}),_:1}),(se=c.value.webhook)!=null&&se.enabled?(y(),v(V,{key:3,label:"Webhook URL"},{default:t(()=>{var p;return[s(m((p=c.value.webhook)==null?void 0:p.url),1)]}),_:1})):M("",!0)]}),_:1}),l(Ce),l(ae,null,{default:t(()=>{var n,b;return[l(r,{onClick:Y},{default:t(()=>[l(i,null,{default:t(()=>[l(T(N))]),_:1}),e[22]||(e[22]=s(" 刷新配置 ",-1))]),_:1}),l(r,{type:"primary",onClick:e[0]||(e[0]=K=>$.value=!0),disabled:!((n=c.value.email)!=null&&n.enabled)},{default:t(()=>[...e[23]||(e[23]=[s(" 测试邮件 ",-1)])]),_:1},8,["disabled"]),l(r,{type:"primary",onClick:we,disabled:!((b=c.value.webhook)!=null&&b.enabled)},{default:t(()=>[...e[24]||(e[24]=[s(" 测试 Webhook ",-1)])]),_:1},8,["disabled"])]}),_:1})]),_:1})]),_:1}),l(z,{label:"审核设置",name:"review"},{default:t(()=>[l(x,null,{default:t(()=>[l(G,{title:"审核设置说明",type:"info",closable:!1,style:{"margin-bottom":"20px"}},{default:t(()=>[...e[25]||(e[25]=[o("ul",{style:{margin:"0","padding-left":"20px"}},[o("li",null,"启用审核后，普通用户创建的应用需要管理员审核通过后才能使用"),o("li",null,"管理员创建的应用可以设置为自动通过审核"),o("li",null,'待审核的应用可以在"应用审核"标签中查看和处理')],-1)])]),_:1}),l(oe,{"label-width":"150px"},{default:t(()=>[l(I,{label:"启用应用审核"},{default:t(()=>[l(ne,{modelValue:w.app_review_enabled,"onUpdate:modelValue":e[1]||(e[1]=n=>w.app_review_enabled=n),onChange:ee},null,8,["modelValue"]),o("span",Ne,m(w.app_review_enabled?"已启用":"已关闭"),1)]),_:1}),l(I,{label:"管理员自动通过"},{default:t(()=>[l(ne,{modelValue:w.auto_approve_admin,"onUpdate:modelValue":e[2]||(e[2]=n=>w.auto_approve_admin=n),onChange:ee,disabled:!w.app_review_enabled},null,8,["modelValue","disabled"]),e[26]||(e[26]=o("span",{style:{"margin-left":"12px",color:"#999","font-size":"14px"}}," 管理员创建的应用自动通过审核 ",-1))]),_:1})]),_:1})]),_:1})]),_:1}),l(z,{label:"应用审核",name:"app-review"},{default:t(()=>[l(x,null,{header:t(()=>[o("div",We,[e[28]||(e[28]=o("span",null,"待审核应用",-1)),l(r,{size:"small",onClick:H},{default:t(()=>[l(i,null,{default:t(()=>[l(T(N))]),_:1}),e[27]||(e[27]=s(" 刷新 ",-1))]),_:1})])]),default:t(()=>[F((y(),v(q,{data:A.value},{default:t(()=>[l(_,{prop:"app_name",label:"应用名称",width:"150"}),l(_,{prop:"package_name",label:"包名",width:"200"}),l(_,{prop:"owner_name",label:"创建者",width:"120"}),l(_,{prop:"description",label:"描述","show-overflow-tooltip":""}),l(_,{prop:"created_at",label:"提交时间",width:"180"}),l(_,{label:"操作",width:"200",fixed:"right"},{default:t(({row:n})=>[l(r,{size:"small",type:"success",onClick:b=>le(n,"approve")},{default:t(()=>[...e[29]||(e[29]=[s(" 通过 ",-1)])]),_:1},8,["onClick"]),l(r,{size:"small",type:"danger",onClick:b=>le(n,"reject")},{default:t(()=>[...e[30]||(e[30]=[s(" 拒绝 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[J,E.value]]),A.value.length===0&&!E.value?(y(),v(te,{key:0,description:"暂无待审核应用"})):M("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(he,{modelValue:$.value,"onUpdate:modelValue":e[6]||(e[6]=n=>$.value=n),title:"测试邮件",width:"500px"},{footer:t(()=>[l(r,{onClick:e[5]||(e[5]=n=>$.value=!1)},{default:t(()=>[...e[31]||(e[31]=[s("取消",-1)])]),_:1}),l(r,{type:"primary",onClick:ge,loading:U.email},{default:t(()=>[...e[32]||(e[32]=[s(" 发送测试邮件 ",-1)])]),_:1},8,["loading"])]),default:t(()=>[l(oe,{"label-width":"100px"},{default:t(()=>[l(I,{label:"收件人"},{default:t(()=>[l(Be,{modelValue:D.value,"onUpdate:modelValue":e[4]||(e[4]=n=>D.value=n),placeholder:"请输入邮箱地址"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}},qe=ze(Re,[["__scopeId","data-v-98685298"]]);export{qe as default};
