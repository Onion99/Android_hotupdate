name: Release Patch

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.4.1)'
        required: true
      base_version:
        description: 'Base version (e.g., 1.4.0)'
        required: true
      description:
        description: 'Release description'
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Build release APK
        run: ./gradlew assembleRelease
      
      - name: Get version from tag or input
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "BASE_VERSION=${{ github.event.inputs.base_version }}" >> $GITHUB_OUTPUT
            echo "DESCRIPTION=${{ github.event.inputs.description }}" >> $GITHUB_OUTPUT
          else
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
            echo "BASE_VERSION=1.4.0" >> $GITHUB_OUTPUT
            echo "DESCRIPTION=Release $VERSION" >> $GITHUB_OUTPUT
          fi
      
      - name: Find patch files
        id: find_patch
        run: |
          # æŸ¥æ‰¾ç”Ÿæˆçš„è¡¥ä¸æ–‡ä»¶
          PATCH_FILE=$(find test_assets -name "patch-*.zip" -type f | head -n 1)
          if [ -z "$PATCH_FILE" ]; then
            echo "No patch file found in test_assets"
            exit 1
          fi
          echo "PATCH_FILE=$PATCH_FILE" >> $GITHUB_OUTPUT
          
          # è®¡ç®— MD5
          MD5=$(md5sum "$PATCH_FILE" | awk '{print $1}')
          echo "MD5=$MD5" >> $GITHUB_OUTPUT
          
          # èŽ·å–æ–‡ä»¶å¤§å°
          SIZE=$(stat -c%s "$PATCH_FILE")
          echo "SIZE=$SIZE" >> $GITHUB_OUTPUT
          
          # é‡å‘½åæ–‡ä»¶
          NEW_NAME="patch-v${{ steps.version.outputs.VERSION }}.zip"
          cp "$PATCH_FILE" "$NEW_NAME"
          echo "NEW_FILE=$NEW_NAME" >> $GITHUB_OUTPUT
      
      - name: Update version.json
        run: |
          # æ›´æ–° version.json
          cat > version.json << EOF
          {
            "latest_version": "${{ steps.version.outputs.VERSION }}",
            "min_version": "${{ steps.version.outputs.BASE_VERSION }}",
            "update_url": "https://github.com/${{ github.repository }}/releases",
            "patches": [
              {
                "version": "${{ steps.version.outputs.VERSION }}",
                "patch_id": "patch_${{ steps.version.outputs.VERSION }}",
                "base_version": "${{ steps.version.outputs.BASE_VERSION }}",
                "download_url": "https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION }}/patch-v${{ steps.version.outputs.VERSION }}.zip",
                "md5": "${{ steps.find_patch.outputs.MD5 }}",
                "size": ${{ steps.find_patch.outputs.SIZE }},
                "description": "${{ steps.version.outputs.DESCRIPTION }}",
                "force_update": false,
                "create_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
              }
            ]
          }
          EOF
          
          cat version.json
      
      - name: Commit version.json
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add version.json
          git commit -m "chore: update version.json for v${{ steps.version.outputs.VERSION }}" || echo "No changes to commit"
          git push origin HEAD:main || echo "Failed to push, continuing..."
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: Release v${{ steps.version.outputs.VERSION }}
          body: |
            ## ðŸ“¦ è¡¥ä¸ç‰ˆæœ¬ v${{ steps.version.outputs.VERSION }}
            
            **åŸºç¡€ç‰ˆæœ¬**: v${{ steps.version.outputs.BASE_VERSION }}
            
            ### ðŸ“ æ›´æ–°è¯´æ˜Ž
            ${{ steps.version.outputs.DESCRIPTION }}
            
            ### ðŸ“Š æ–‡ä»¶ä¿¡æ¯
            - **æ–‡ä»¶å**: patch-v${{ steps.version.outputs.VERSION }}.zip
            - **MD5**: `${{ steps.find_patch.outputs.MD5 }}`
            - **å¤§å°**: ${{ steps.find_patch.outputs.SIZE }} bytes
            
            ### ðŸ“¥ ä¸‹è½½æ–¹å¼
            
            **æ–¹å¼ 1: ç›´æŽ¥ä¸‹è½½**
            ```
            https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION }}/patch-v${{ steps.version.outputs.VERSION }}.zip
            ```
            
            **æ–¹å¼ 2: å®¢æˆ·ç«¯è‡ªåŠ¨æ›´æ–°**
            ```kotlin
            // èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
            val versionUrl = "https://raw.githubusercontent.com/${{ github.repository }}/main/version.json"
            ```
            
            ### ðŸ”§ ä½¿ç”¨æ–¹æ³•
            
            1. ä¸‹è½½è¡¥ä¸æ–‡ä»¶
            2. å°†è¡¥ä¸æ–‡ä»¶æ”¾åˆ° `/sdcard/Download/` ç›®å½•
            3. åœ¨åº”ç”¨ä¸­ç‚¹å‡»"åº”ç”¨è¡¥ä¸"æŒ‰é’®
            4. é‡å¯åº”ç”¨ç”Ÿæ•ˆ
            
            ---
            
            ðŸ“– [æŸ¥çœ‹å®Œæ•´æ–‡æ¡£](https://github.com/${{ github.repository }})
          files: |
            ${{ steps.find_patch.outputs.NEW_FILE }}
            app/build/outputs/apk/release/app-release.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
